name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ipa:
    runs-on: macos-14
    env:
      SCHEME: TimerFuturiste
      PROJECT: TimerFuturiste.xcodeproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (16.x compatible)
        run: |
          set -euo pipefail
          if [ -d /Applications/Xcode_16.4.app ]; then
            sudo xcode-select -s /Applications/Xcode_16.4.app
          elif [ -d /Applications/Xcode_16.3.app ]; then
            sudo xcode-select -s /Applications/Xcode_16.3.app
          elif [ -d /Applications/Xcode_16.2.app ]; then
            sudo xcode-select -s /Applications/Xcode_16.2.app
          elif [ -d /Applications/Xcode_16.1.app ]; then
            sudo xcode-select -s /Applications/Xcode_16.1.app
          elif [ -d /Applications/Xcode_16.0.app ]; then
            sudo xcode-select -s /Applications/Xcode_16.0.app
          elif [ -d /Applications/Xcode.app ]; then
            sudo xcode-select -s /Applications/Xcode.app
          fi
      - name: Verify Xcode version
        run: xcodebuild -version

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Build app (unsigned)
        run: |
          set -euo pipefail
          xcodebuild \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            clean build

      - name: Package unsigned IPA
        run: |
          set -euo pipefail
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData -path "*/Build/Products/Release-iphoneos/*.app" | head -n 1)
          if [ -z "${APP_PATH:-}" ]; then
            echo "No .app found in DerivedData Release-iphoneos output"
            exit 1
          fi

          mkdir -p build/Payload
          cp -R "$APP_PATH" build/Payload/
          cd build
          zip -r TimerFuturiste-unsigned.ipa Payload

      - name: Verify IPA artifact
        run: |
          ls -lah build
          unzip -l build/TimerFuturiste-unsigned.ipa | head -n 20

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: TimerFuturiste-unsigned-ipa
          path: build/TimerFuturiste-unsigned.ipa
          if-no-files-found: error

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-logs
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/Logs/Build/*.xcactivitylog
          if-no-files-found: ignore
